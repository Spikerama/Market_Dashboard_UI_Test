<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Market Warning Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Preconnect and fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    :root {
      --bg: #1f212a;
      --card-bg: #2c2f40;
      --radius: 18px;
      --shadow: 0 25px 60px -15px rgba(0,0,0,0.6);
      --text-primary: rgba(255,255,255,0.92);
      --text-secondary: rgba(200,205,220,0.7);
      --live: #00d084;
      --cached: #6f7ea8;
      --error: #ff6f6f;
      --border: rgba(255,255,255,0.08);
      --transition: .35s cubic-bezier(.4,.2,.2,1);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 1.5rem 1rem 3rem;
      background: var(--bg);
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text-primary);
      min-height: 100vh;
    }
    .app {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: .5rem;
      padding: .75rem 1rem;
    }
    .title { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: .5rem; }
    .sub { font-size: .85rem; color: var(--text-secondary); margin-top: 2px; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: .5rem;
    }
    .card {
      position: relative;
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1.25rem 1rem 1.5rem;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      transition: transform var(--transition), box-shadow var(--transition);
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .card.alert { box-shadow: 0 0 25px 3px var(--error); }
    .card:hover { transform: translateY(-2px); box-shadow: 0 20px 50px -10px rgba(255,255,255,0.2); }
    .small-label { font-size: .55rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); margin-bottom: 4px; }
    h2 { margin: 0; font-size: .95rem; font-weight: 600; letter-spacing: .5px; display: flex; justify-content: space-between; align-items: baseline; cursor: grab; }
    .value {
      font-size: 2.2rem;
      font-weight: 700;
      margin-top: 6px;
      display: flex;
      align-items: baseline;
      gap: 6px;
      color: var(--text-primary);
      position: relative;
    }
    .threshold-bar {
      position: absolute;
      left: 0; right: 0; top: 50%;
      height: 8px; border-radius: 4px;
      transform: translateY(-50%);
      background: linear-gradient(90deg,#28c17d 0%,#ffcd3c 60%,#ff6f6f 100%);
      z-index: 0;
    }
    .threshold-inner { position: absolute; left: 0; top: 0; bottom: 0; border-radius: 4px; z-index: 1; }
    .threshold-label { margin-left: 8px; font-size: .6rem; font-weight: 600; letter-spacing: 1px; }
    .change { font-size: .85rem; margin-top: 4px; display: flex; align-items: center; gap: 4px; }
    .up { color: var(--live); }
    .down { color: var(--error); }
    .badge {
      font-size: .55rem;
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 600;
      display: inline-block;
      margin-left: 6px;
      text-transform: uppercase;
      letter-spacing: .5px;
      background: rgba(255,255,255,0.08);
      color: var(--text-primary);
    }
    .badge-live { background: var(--live); color: #fff; font-weight: 700; border: 1px solid rgba(255,255,255,0.1); }
    .badge-cached { background: var(--cached); color: #fff; }
    .badge-error { background: var(--error); color: #fff; }
    .timestamp { font-size: .55rem; margin-top: 6px; color: var(--text-secondary); }
    .stale { font-size: .55rem; color: var(--text-secondary); margin-top: 2px; }
    .spinner {
      width: 16px; height: 16px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top: 3px solid #8b9cff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-left: 4px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .note { font-size: .55rem; color: var(--text-secondary); margin-top: 6px; }
    .mini { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; margin-top: 4px; }
    .header-right { display: flex; gap: 1rem; flex-wrap: wrap; font-size: .9rem; }
    .legend { display: flex; gap: .75rem; align-items: center; }
    .legend .badge { margin: 0; }
    .sparkline { width: 100px; height: 28px; }
    .temp-bar {
      width: 100%; height: 14px; border-radius: 7px;
      background: linear-gradient(90deg,#28c17d 0%,#ffcd3c 60%,#ff6f6f 100%);
      position: relative; overflow: hidden; margin-top: 4px;
    }
    .temp-marker {
      position: absolute; top: 0; bottom: 0; width: 6px; border-radius: 3px;
      transform: translateX(-50%); box-shadow: 0 0 12px rgba(255,255,255,0.4);
    }
    .temp-needle {
      position: absolute; top: 0; bottom: 0; width: 2px; background: #fff;
      box-shadow: 0 0 8px rgba(255,255,255,0.8);
      transform: translateX(-50%); pointer-events: none; z-index: 2;
    }
    .temp-label { margin-top: 4px; font-size: .75rem; }
    .sortable-ghost {
      opacity: .6; transform: scale(1.02);
      box-shadow: 0 35px 80px -10px rgba(255,255,255,0.1);
    }
    /* hide threshold bars on Buffett widgets */
    #card-buffett .threshold-bar,
    #card-buffett .threshold-inner,
    #card-estimated-buffett .threshold-bar,
    #card-estimated-buffett .threshold-inner {
      display: none;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div>
        <div class="title">Market Warning Dashboard</div>
        <div class="sub">Dark theme · Aggregated risk temperature · Live / Cached / Alerts</div>
      </div>
      <div class="header-right">
        <div>Global updated: <strong id="global-updated">--:--:--</strong></div>
        <div class="legend">
          <div class="badge badge-live">LIVE</div>
          <div class="badge badge-cached">CACHED</div>
          <div class="badge badge-error">ERROR</div>
        </div>
      </div>
    </div>

    <div class="grid" id="dashboard-grid">
      <!-- Risk Temperature -->
      <div class="card" data-widget="risk-temp" id="card-risk-temp">
        <div class="small-label">Aggregate</div>
        <h2>Risk Temperature</h2>
        <div class="value" style="flex-direction:column;gap:4px;">
          <div style="display:flex;align-items:center;gap:8px;">
            <div id="risk-temp-score" style="font-size:2rem;">--%</div>
            <div id="risk-temp-status" class="badge" style="font-size:1.25rem;padding:4px 10px;background:none;">--</div>
          </div>
          <div class="temp-bar">
            <div class="temp-needle" id="risk-temp-needle"></div>
            <div class="temp-marker" id="risk-temp-marker" style="left:0;background:rgba(255,255,255,0.9);"></div>
          </div>
        </div>
        <div class="temp-label" id="risk-temp-details">Loading...</div>
        <div class="timestamp" id="risk-temp-updated">Updated: --</div>
      </div>

      <!-- SPY -->
      <div class="card" data-widget="sp500" id="card-sp500">
        <div class="small-label">Equity</div>
        <h2>S&P 500 (SPY)</h2>
        <div class="value" id="sp500">
          -- <span id="sp500-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="sp500-change"></div>
          <div id="sp500-status" class="badge">--</div>
          <div class="sparkline" id="sp500-spark"></div>
        </div>
        <div class="stale" id="sp500-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="sp500-updated">Updated: --</div>
      </div>

      <!-- Yield Curve -->
      <div class="card" data-widget="yield" id="card-yield">
        <div class="small-label">Macro</div>
        <h2>10Y − 2Y Yield Curve Spread</h2>
        <div class="value" id="yield">
          -- <span id="yield-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="yield-change"></div>
          <div id="yield-status" class="badge">--</div>
          <div class="sparkline" id="yield-spark"></div>
        </div>
        <div class="stale" id="yield-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="yield-updated">Updated: --</div>
      </div>

      <!-- Buffett Indicator -->
      <div class="card" data-widget="buffett" id="card-buffett">
        <div class="small-label">Valuation</div>
        <h2>Buffett Indicator</h2>
        <div class="value" id="buffett-wrapper" style="position:relative;">
          <div style="display:flex;align-items:center;gap:6px;width:100%;">
            <div id="buffett">-- <span id="buffett-spinner" class="spinner" style="display:none;"></span></div>
            <div class="threshold-label" id="buffett-label">--</div>
          </div>
        </div>
        <div class="mini">
          <div class="change" id="buffett-change"></div>
          <div id="buffett-status" class="badge">--</div>
          <div class="sparkline" id="buffett-spark"></div>
        </div>
        <div class="stale" id="buffett-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="buffett-updated">Updated: --</div>
        <div class="note">Market cap / GDP. High readings signal overvaluation.</div>
      </div>

      <!-- Estimated Buffett -->
      <div class="card" data-widget="estimated-buffett" id="card-estimated-buffett">
        <div class="small-label">Valuation</div>
        <h2>Estimated Buffett (S&P scaled)</h2>
        <div style="font-size:.6rem;margin-top:2px;">Approx: S&P 500 cap × 1.30 / GDP</div>
        <div class="value" id="estimated-buffett-wrapper" style="position:relative;">
          <div style="display:flex;align-items:center;gap:6px;width:100%;">
            <div id="estimated-buffett">-- <span id="estimated-buffett-spinner" class="spinner" style="display:none;"></span></div>
            <div class="threshold-label" id="estimated-buffett-label">--</div>
          </div>
        </div>
        <div class="mini">
          <div class="change" id="estimated-buffett-change"></div>
          <div id="estimated-buffett-status" class="badge">--</div>
          <div class="sparkline" id="estimated-buffett-spark"></div>
        </div>
        <div class="stale" id="estimated-buffett-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="estimated-buffett-updated">Updated: --</div>
      </div>

      <!-- Tesla -->
      <div class="card" data-widget="tsla" id="card-tsla">
        <div class="small-label">Equity</div>
        <h2>Tesla (TSLA)</h2>
        <div class="value" id="tsla">
          -- <span id="tsla-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="tsla-change"></div>
          <div id="tsla-status" class="badge">--</div>
          <div class="sparkline" id="tsla-spark"></div>
        </div>
        <div class="stale" id="tsla-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="tsla-updated">Updated: --</div>
      </div>

      <!-- Lithium -->
      <div class="card" data-widget="lithium" id="card-lithium">
        <div class="small-label">Commodity Proxy</div>
        <h2>Lithium Spot Proxy (LIT ETF)</h2>
        <div class="value" id="lithium">
          -- <span id="lithium-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="lithium-change"></div>
          <div id="lithium-status" class="badge">--</div>
        </div>
        <div class="stale" id="lithium-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="lithium-updated">Updated: --</div>
      </div>

      <!-- VIXY -->
      <div class="card" data-widget="vixy" id="card-vixy">
        <div class="small-label">Volatility</div>
        <h2>VIXY</h2>
        <div class="value" id="vix">
          -- <span id="vix-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="vix-change"></div>
          <div id="vix-status" class="badge">--</div>
        </div>
        <div class="stale" id="vix-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="vix-updated">Updated: --</div>
      </div>
    </div>

    <div class="note">
      Data sources: TwelveData for ETFs, Netlify functions for VIX index, yield spread, Estimated Buffett.
      Aggregated “Risk Temperature” mixes structural and near-term market stress.
    </div>
  </div>

  <script>
    const TWELVE_KEY = '26137bba624c4dcb9b5284ad1b234071';

    function cacheSet(key, obj) { try { localStorage.setItem(key, JSON.stringify({ ts: Date.now(), data: obj })); } catch {} }
    function cacheGet(key) { try { return JSON.parse(localStorage.getItem(key)); } catch { return null; } }

    function setStatus(el, type) {
      if (!el) return;
      el.classList.remove('badge-live', 'badge-cached', 'badge-error');
      el.classList.add('badge');
      if (type === 'LIVE')      el.textContent = 'LIVE',       el.classList.add('badge-live');
      else if (type === 'CACHED') el.textContent = 'CACHED',    el.classList.add('badge-cached');
      else if (type === 'ERROR')  el.textContent = 'ERROR',     el.classList.add('badge-error');
      else                         el.textContent = type;
    }

    async function fetchWithRetry(url, attempts = 3, baseDelay = 300) {
      for (let i = 0; i < attempts; i++) {
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return await res.json();
        } catch (e) {
          console.error(`🔥 fetch error (${url}):`, e);
          if (i === attempts - 1) throw e;
          await new Promise(r => setTimeout(r, baseDelay * (i + 1)));
        }
      }
    }

    async function getTwelveQuote(symbol) {
      const url = `https://api.twelvedata.com/quote?symbol=${encodeURIComponent(symbol)}&apikey=${TWELVE_KEY}`;
      return await fetchWithRetry(url);
    }

    function setCard(id, value, change, useCache = false) {
      const valEl = document.getElementById(id);
      const changeEl = document.getElementById(id + '-change');
      const staleEl = document.getElementById(id + '-stale');
      const statusEl = document.getElementById(id + '-status');
      if (isNaN(value)) {
        if (valEl) valEl.textContent = 'Error';
        if (changeEl) changeEl.textContent = '';
        if (staleEl) staleEl.style.display = 'none';
        return setStatus(statusEl, 'ERROR');
      }
      if (valEl) valEl.textContent = parseFloat(value).toFixed(2);
      if (typeof change === 'number' && changeEl) {
        const arrow = change >= 0 ? '▲' : '▼';
        changeEl.textContent = `${arrow} ${Math.abs(change).toFixed(2)}%`;
        changeEl.className = 'change ' + (change >= 0 ? 'up' : 'down');
      }
      if (staleEl) staleEl.style.display = useCache ? 'block' : 'none';
    }

    function pushHistory(key, value) {
      try {
        let arr = JSON.parse(localStorage.getItem(`spark_${key}`)) || [];
        arr.push(value);
        if (arr.length > 30) arr = arr.slice(-30);
        localStorage.setItem(`spark_${key}`, JSON.stringify(arr));
      } catch {}
    }
    function getHistory(key) {
      try {
        return JSON.parse(localStorage.getItem(`spark_${key}`)) || [];
      } catch { return []; }
    }
    function drawSparkline(containerId, data) {
      const w = 100, h = 28;
      if (!data.length) { document.getElementById(containerId).innerHTML = ''; return; }
      const max = Math.max(...data), min = Math.min(...data), range = max - min || 1;
      let path = '';
      data.forEach((v, i) => {
        const x = (i/(data.length-1)) * w;
        const y = h - ((v - min)/range)*h;
        path += i===0 ? `M${x},${y}` : ` L${x},${y}`;
      });
      document.getElementById(containerId).innerHTML = `
        <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
          <path d="${path}" fill="none" stroke="rgba(255,255,255,0.7)" stroke-width="1.5" stroke-linecap="round"/>
        </svg>`;
    }

    function interpolateColor(from, to, t) {
      const parse = hex => parseInt(hex.slice(1), 16);
      const r1 = (parse(from)>>16)&255, g1=(parse(from)>>8)&255, b1=parse(from)&255;
      const r2 = (parse(to)>>16)&255, g2=(parse(to)>>8)&255, b2=parse(to)&255;
      const rn = Math.round(r1 + (r2-r1)*t),
            gn = Math.round(g1 + (g2-g1)*t),
            bn = Math.round(b1 + (b2-b1)*t);
      return `rgb(${rn},${gn},${bn})`;
    }
    function riskColor(score) {
      return score <=50
        ? interpolateColor('#28c17d','#ffcd3c', score/50)
        : interpolateColor('#ffcd3c','#ff6f6f', (score-50)/50);
    }

    async function refreshSPY() {
      console.log('🔄 refreshSPY');
      const spinner = document.getElementById('sp500-spinner');
      spinner && (spinner.style.display='inline-block');
      try {
        const q = await getTwelveQuote('SPY');
        const price = parseFloat(q.close), pct = parseFloat(q.percent_change);
        setCard('sp500', price, pct, false);
        cacheSet('sp500', { price, pct });
        document.getElementById('sp500-updated').textContent = 'Updated: ' + new Date().toLocaleTimeString();
        setStatus(document.getElementById('sp500-status'), 'LIVE');
        pushHistory('sp500', price); drawSparkline('sp500-spark', getHistory('sp500'));
      } catch (e) {
        console.error('🔥 refreshSPY error:', e);
        const cached = cacheGet('sp500');
        if (cached?.data) {
          setCard('sp500', cached.data.price, cached.data.pct, true);
          document.getElementById('sp500-updated').textContent = 'Updated: ' + new Date(cached.ts).toLocaleTimeString() + ' (cached)';
          setStatus(document.getElementById('sp500-status'),'CACHED');
          pushHistory('sp500', cached.data.price); drawSparkline('sp500-spark', getHistory('sp500'));
        } else {
          setCard('sp500', NaN, NaN, false);
        }
      }
    }

    async function refreshYieldCurve() {
      console.log('🔄 refreshYieldCurve');
      const spinner = document.getElementById('yield-spinner');
      spinner && (spinner.style.display='inline-block');
      try {
        const res = await fetch(`/.netlify/functions/yieldSpread?bust=${Date.now()}`);
        const json = await res.json();
        if (json.error) throw new Error(json.error);
        const { spread, inverted } = json;
        document.getElementById('yield').textContent = `${spread.toFixed(2)}%`;
        const changeEl = document.getElementById('yield-change');
        changeEl.textContent = `${spread>=0?'▲':'▼'} ${inverted?'Inverted':'Normal'}`;
        changeEl.className = 'change ' + (spread>=0?'up':'down');
        cacheSet('yield', { spread, inverted });
        document.getElementById('yield-stale').style.display='none';
        document.getElementById('yield-updated').textContent = 'Updated: ' + new Date().toLocaleTimeString();
        setStatus(document.getElementById('yield-status'), inverted?'INVERTED':'NORMAL');
        pushHistory('yield', spread); drawSparkline('yield-spark', getHistory('yield'));
      } catch (e) {
        console.error('🔥 refreshYieldCurve error:', e);
        const cached = cacheGet('yield');
        if (cached?.data) {
          const { spread, inverted } = cached.data;
          document.getElementById('yield').textContent = `${spread.toFixed(2)}%`;
          const changeEl = document.getElementById('yield-change');
          changeEl.textContent = `${spread>=0?'▲':'▼'} ${inverted?'Inverted':'Normal'}`;
          changeEl.className = 'change ' + (spread>=0?'up':'down');
          document.getElementById('yield-stale').style.display='block';
          document.getElementById('yield-updated').textContent = 'Updated: ' + new Date(cached.ts).toLocaleTimeString() + ' (cached)';
          setStatus(document.getElementById('yield-status'), inverted?'INVERTED':'NORMAL');
          pushHistory('yield', spread); drawSparkline('yield-spark', getHistory('yield'));
        } else {
          setCard('yield', NaN, NaN, false);
        }
      }
    }

    async function refreshEstimatedBuffett() {
      console.log('🔄 refreshEstimatedBuffett');
      const spinner = document.getElementById('estimated-buffett-spinner');
      spinner && (spinner.style.display='inline-block');
      try {
        const res = await fetch('/.netlify/functions/estimatedBuffett');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        if (json.error) throw new Error(json.error);
        const ratio = json.ratio, over = ratio>=3.0;
        document.getElementById('estimated-buffett').textContent = `${ratio.toFixed(2)}%`;
        const changeEl = document.getElementById('estimated-buffett-change');
        changeEl.textContent = over?'▲ Overvalued':(ratio>=2.5?'▲ Caution':'▼ Normal');
        changeEl.className = 'change ' + (over?'up':(ratio>=2.5?'up':'down'));
        const inner = document.getElementById('estimated-buffett-threshold');
        const label = document.getElementById('estimated-buffett-label');
        const width = Math.min((ratio/5)*100,100);
        inner && (inner.style.width=`${width}%`);
        if (ratio<2.5) inner.style.background='#28c17d', label.textContent='Normal';
        else if (ratio<3.0) inner.style.background='#ffcd3c', label.textContent='Caution';
        else inner.style.background='#ff6f6f', label.textContent='Overvalued';
        document.getElementById('estimated-buffett-stale').style.display='none';
        document.getElementById('estimated-buffett-updated').textContent = 'Updated: '+new Date().toLocaleTimeString();
        setStatus(document.getElementById('estimated-buffett-status'), over?'ALERT':'OK');
        cacheSet('estimated-buffett',{ ratio, over });
        pushHistory('estimated-buffett', ratio); drawSparkline('estimated-buffett-spark', getHistory('estimated-buffett'));
      } catch (e) {
        console.error('🔥 refreshEstimatedBuffett error:', e);
        const cached=cacheGet('estimated-buffett');
        if (cached?.data) {
          const { ratio, over } = cached.data;
          document.getElementById('estimated-buffett').textContent=`${ratio.toFixed(2)}%`;
          const changeEl=document.getElementById('estimated-buffett-change');
          changeEl.textContent = over?'▲ Overvalued':(ratio>=2.5?'▲ Caution':'▼ Normal');
          changeEl.className='change '+(over?'up':(ratio>=2.5?'up':'down'));
          const inner=document.getElementById('estimated-buffett-threshold');
          const label=document.getElementById('estimated-buffett-label');
          const width=Math.min((ratio/5)*100,100);
          inner&&(inner.style.width=`${width}%`);
          if(ratio<2.5) inner.style.background='#28c17d', label.textContent='Normal';
          else if(ratio<3.0) inner.style.background='#ffcd3c', label.textContent='Caution';
          else inner.style.background='#ff6f6f', label.textContent='Overvalued';
          document.getElementById('estimated-buffett-stale').style.display='block';
          document.getElementById('estimated-buffett-updated').textContent = 'Updated: '+new Date(cached.ts).toLocaleTimeString()+' (cached)';
          setStatus(document.getElementById('estimated-buffett-status'), over?'ALERT':'OK');
          pushHistory('estimated-buffett', ratio); drawSparkline('estimated-buffett-spark', getHistory('estimated-buffett'));
        } else {
          setCard('estimated-buffett', NaN, NaN, false);
        }
      }
    }

    async function refreshTSLA() {
      console.log('🔄 refreshTSLA');
      const spinner = document.getElementById('tsla-spinner');
      spinner && (spinner.style.display='inline-block');
      try {
        const q = await getTwelveQuote('TSLA');
        const price = parseFloat(q.close), pct = parseFloat(q.percent_change);
        setCard('tsla', price, pct, false);
        cacheSet('tsla',{ price, pct });
        document.getElementById('tsla-updated').textContent = 'Updated: '+new Date().toLocaleTimeString();
        setStatus(document.getElementById('tsla-status'),'LIVE');
        pushHistory('tsla', price); drawSparkline('tsla-spark', getHistory('tsla'));
      } catch (e) {
        console.error('🔥 refreshTSLA error:', e);
        const cached=cacheGet('tsla');
        if(cached?.data) {
          setCard('tsla', cached.data.price, cached.data.pct, true);
          document.getElementById('tsla-updated').textContent = 'Updated: '+new Date(cached.ts).toLocaleTimeString()+' (cached)';
          setStatus(document.getElementById('tsla-status'),'CACHED');
          pushHistory('tsla', cached.data.price); drawSparkline('tsla-spark', getHistory('tsla'));
        } else {
          setCard('tsla', NaN, NaN, false);
        }
      }
    }

    async function refreshLithium() {
      console.log('🔄 refreshLithium');
      const spinner=document.getElementById('lithium-spinner');
      spinner&&(spinner.style.display='inline-block');
      try {
        const q=await getTwelveQuote('LIT');
        const price=parseFloat(q.close), pct=parseFloat(q.percent_change);
        setCard('lithium', price, pct, false);
        cacheSet('lithium',{ price, pct });
        document.getElementById('lithium-updated').textContent='Updated: '+new Date().toLocaleTimeString();
        setStatus(document.getElementById('lithium-status'),'LIVE');
      } catch(e) {
        console.error('🔥 refreshLithium error:', e);
        const cached=cacheGet('lithium');
        if(cached?.data) {
          setCard('lithium', cached.data.price, cached.data.pct, true);
          document.getElementById('lithium-updated').textContent='Updated: '+new Date(cached.ts).toLocaleTimeString()+' (cached)';
          setStatus(document.getElementById('lithium-status'),'CACHED');
        } else {
          setCard('lithium', NaN, NaN, false);
        }
      }
    }

    async function refreshVIX() {
      console.log('🔄 refreshVIXY');
      const spinner=document.getElementById('vix-spinner');
      spinner&&(spinner.style.display='inline-block');
      try {
        const q=await getTwelveQuote('VIXY');
        const price=parseFloat(q.close), pct=parseFloat(q.percent_change);
        setCard('vix', price, pct, false);
        cacheSet('vix',{ price, pct });
        document.getElementById('vix-updated').textContent='Updated: '+new Date().toLocaleTimeString();
        setStatus(document.getElementById('vix-status'),'LIVE');
      } catch(e) {
        console.error('🔥 refreshVIXY error:', e);
        const cached=cacheGet('vix');
        if(cached?.data) {
          setCard('vix', cached.data.price, cached.data.pct, true);
          document.getElementById('vix-updated').textContent='Updated: '+new Date(cached.ts).toLocaleTimeString()+' (cached)';
          setStatus(document.getElementById('vix-status'),'CACHED');
        } else {
          setCard('vix', NaN, NaN, false);
        }
      }
    }

    async function refreshVIXIndex() {
      console.log('🔄 refreshVIXIndex');
      const spinner=document.getElementById('vix-index-spinner');
      spinner&&(spinner.style.display='inline-block');
      try {
        const res=await fetch('/.netlify/functions/vixIndex');
        const json=await res.json();
        if(json.error) throw new Error(json.error);
        const price=parseFloat(json.price), change=json.changePercent!=null?parseFloat(json.changePercent):NaN;
        setCard('vix-index', price, change, false);
        cacheSet('vix-index',{ price, change });
        document.getElementById('vix-index-updated').textContent='Updated: '+new Date().toLocaleTimeString();
        setStatus(document.getElementById('vix-index-status'),'LIVE');
      } catch(e) {
        console.error('🔥 refreshVIXIndex error:', e);
        const cached=cacheGet('vix-index');
        if(cached?.data) {
          setCard('vix-index', cached.data.price, cached.data.change, true);
          document.getElementById('vix-index-updated').textContent='Updated: '+new Date(cached.ts).toLocaleTimeString()+' (cached)';
          setStatus(document.getElementById('vix-index-status'),'CACHED');
        } else {
          setCard('vix-index', NaN, NaN, false);
        }
      }
    }

    function refreshRiskTemperature() {
      console.log('🔄 refreshRiskTemperature');
      const now=new Date();
      const est=cacheGet('estimated-buffett')?.data;
      const y=cacheGet('yield')?.data;
      const s=cacheGet('sp500')?.data;
      const v=cacheGet('vix')?.data;
      const t=cacheGet('tsla')?.data;

      let score=0, contributors=[];

      if(y && y.spread<0) { score+=25; contributors.push('Yield inverted'); }
      if(est && est.ratio>=3.0) { score+=30; contributors.push(`EstBuffett≥${est.ratio.toFixed(2)}`); }
      if(s && typeof s.pct==='number' && s.pct<=-1) { score+=10; contributors.push(`SPY down${s.pct.toFixed(2)}%`); }
      if(v && typeof v.pct==='number' && v.pct>=5) { score+=10; contributors.push(`VIXY up${v.pct.toFixed(2)}%`); }
      if(t && typeof t.pct==='number' && t.pct<=-1.5) { score+=10; contributors.push(`TSLA down${t.pct.toFixed(2)}%`); }

      score=Math.min(100, score);
      const marker=document.getElementById('risk-temp-marker'),
            needle=document.getElementById('risk-temp-needle'),
            scoreEl=document.getElementById('risk-temp-score'),
            statusEl=document.getElementById('risk-temp-status'),
            detailsEl=document.getElementById('risk-temp-details'),
            updatedEl=document.getElementById('risk-temp-updated'),
            card=document.getElementById('card-risk-temp');
      const color=riskColor(score);

      marker&&(marker.style.left=`${score}%`, marker.style.background=color);
      needle&&(needle.style.left=`${score}%`);
      scoreEl&&(scoreEl.textContent=`${score}%`);

      let text='Normal';
      if(score>=70) text='High Risk';
      else if(score>=40) text='Elevated';

      statusEl&&(statusEl.textContent=text, statusEl.style.color=color, statusEl.style.background='none');
      detailsEl&&(detailsEl.textContent=contributors.join(', ')||'No stress signals');
      updatedEl&&(updatedEl.textContent='Updated: '+now.toLocaleTimeString());
      if(card) card.classList.toggle('alert', score>=70);
    }

    function initDragReorder() {
      const grid=document.getElementById('dashboard-grid'), saved=localStorage.getItem('dashboard_order');
      if(grid && saved) {
        try {
          JSON.parse(saved).forEach(id=>{
            const c=document.querySelector(`[data-widget="${id}"]`);
            c&&grid.appendChild(c);
          });
        } catch{}
      }
      Sortable.create(grid, {
        animation:150,
        handle:'h2',
        ghostClass:'sortable-ghost',
        onEnd:()=> {
          const order=Array.from(grid.children).map(c=>c.getAttribute('data-widget'));
          localStorage.setItem('dashboard_order', JSON.stringify(order));
        }
      });
    }

    function updateGlobalTimestamp() {
      console.log('⏰ updateGlobalTimestamp');
      document.getElementById('global-updated').textContent=new Date().toLocaleTimeString();
    }

    async function boot() {
      console.log('⚡ Dashboard booting…');
      refreshSPY();
      refreshYieldCurve();
      refreshEstimatedBuffett();
      refreshTSLA();
      refreshLithium();
      refreshVIX();
      refreshVIXIndex();
      setTimeout(refreshRiskTemperature, 500);
      updateGlobalTimestamp();
      initDragReorder();

      setInterval(() => {
        console.log('⏱️ 120s tick: refreshing all widgets');
        refreshSPY();
        refreshYieldCurve();
        refreshEstimatedBuffett();
        refreshTSLA();
        refreshLithium();
        refreshVIX();
        refreshVIXIndex();
        refreshRiskTemperature();
        updateGlobalTimestamp();
      }, 120000);

      setInterval(() => {
        console.log('⏱️ 30s tick: refreshing risk temperature');
        refreshRiskTemperature();
      }, 30000);
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
