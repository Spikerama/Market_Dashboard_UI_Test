<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Market Warning Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    /* — your CSS exactly as before — */
    :root { --bg:#1f212a; --card-bg:#2c2f40; --radius:18px; --shadow:0 25px 60px -15px rgba(0,0,0,0.6); --text-primary:rgba(255,255,255,0.92); --text-secondary:rgba(200,205,220,0.7); --live:#00d084; --cached:#6f7ea8; --error:#ff6f6f; --border:rgba(255,255,255,0.08); --transition:.35s cubic-bezier(.4,.2,.2,1);}
    /* … rest of your CSS … */
  </style>
</head>
<body>
  <div class="app">
    <!-- — your HTML for header and all widget cards exactly as before — -->
  </div>

  <script>
    const TWELVE_KEY = '26137bba624c4dcb9b5284ad1b234071';

    function cacheSet(key, obj) { try { localStorage.setItem(key, JSON.stringify({ ts: Date.now(), data: obj })); } catch {} }
    function cacheGet(key) { try { return JSON.parse(localStorage.getItem(key)); } catch { return null; } }

    function setStatus(el, type) {
      /* … unchanged … */
    }

    async function fetchWithRetry(url, attempts = 3, baseDelay = 300) {
      /* … unchanged … */
    }

    async function getTwelveQuote(symbol) {
      /* … unchanged … */
    }

    function setCard(id, value, change, useCache = false) {
      /* … unchanged … */
    }

    function pushHistory(key, value) {
      /* … unchanged … */
    }
    function getHistory(key) {
      /* … unchanged … */
    }
    function drawSparkline(containerId, data) {
      /* … unchanged … */
    }

    function interpolateColor(from, to, t) {
      /* … unchanged … */
    }

    function riskColor(score) {
      /* … unchanged … */
    }

    async function refreshSPY() {
      /* … unchanged … */
    }

    async function refreshYieldCurve() {
      const spinner = document.getElementById('yield-spinner');
      if (spinner) spinner.style.display = 'inline-block';
      try {
        // ←– only this line changed:
        const res = await fetch(`/.netlify/functions/yieldSpread?bust=${Date.now()}`);
        const json = await res.json();
        if (json.error) throw new Error(json.error);
        const spread = json.spread;
        const inverted = json.inverted;
        // … rest unchanged …
      } catch (e) {
        // … unchanged …
      }
    }

    async function refreshEstimatedBuffett() {
      const spinner = document.getElementById('estimated-buffett-spinner');
      if (spinner) spinner.style.display = 'inline-block';
      try {
        // ←– only this line changed:
        const res = await fetch(`/.netlify/functions/estimatedBuffett?bust=${Date.now()}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        // … rest unchanged …
      } catch (e) {
        // … unchanged …
      }
    }

    async function refreshTSLA() {
      /* … unchanged … */
    }

    async function refreshLithium() {
      /* … unchanged … */
    }

    async function refreshVIX() {
      const spinner = document.getElementById('vix-spinner');
      if (spinner) spinner.style.display = 'inline-block';
      try {
        const q = await getTwelveQuote('VIXY');
        const price = parseFloat(q.close);
        const pct = parseFloat(q.percent_change);
        setCard('vix', price, pct, false);
        cacheSet('vix', { price, pct });
        document.getElementById('vix-updated').textContent = 'Updated: ' + new Date().toLocaleTimeString();
        setStatus(document.getElementById('vix-status'), 'LIVE');
      } catch (e) {
        console.error('VIXY error', e);
        const cached = cacheGet('vix');
        if (cached?.data) {
          setCard('vix', cached.data.price, cached.data.pct, true);
          // ←– only this one-character fix here (“ccached” → “cached”):
          const ts = cached.ts ? new Date(cached.ts).toLocaleTimeString() : '--';
          document.getElementById('vix-updated').textContent = 'Updated: ' + ts + ' (cached)';
          setStatus(document.getElementById('vix-status'), 'CACHED');
        } else {
          setCard('vix', null, null, false);
          document.getElementById('vix-updated').textContent = 'Updated: --';
          setStatus(document.getElementById('vix-status'), 'ERROR');
        }
      }
    }

    async function refreshVIXIndex() {
      const spinner = document.getElementById('vix-index-spinner');
      if (spinner) spinner.style.display = 'inline-block';
      try {
        // ←– only this line changed:
        const res = await fetch(`/.netlify/functions/vixIndex?bust=${Date.now()}`);
        const json = await res.json();
        if (json.error) throw new Error(json.error);
        const price = parseFloat(json.price);
        const change = json.changePercent != null ? parseFloat(json.changePercent) : null;
        setCard('vix-index', price, change, false);
        cacheSet('vix-index', { price, change });
        document.getElementById('vix-index-updated').textContent = 'Updated: ' + new Date().toLocaleTimeString();
        setStatus(document.getElementById('vix-index-status'), 'LIVE');
      } catch (e) {
        // … unchanged …
      }
    }

    function refreshRiskTemperature() { /* … unchanged … */ }
    function initDragReorder() { /* … unchanged … */ }
    function updateGlobalTimestamp() { /* … unchanged … */ }

    async function boot() {
      refreshSPY();
      refreshYieldCurve();
      refreshEstimatedBuffett();
      refreshTSLA();
      refreshLithium();
      refreshVIX();
      refreshVIXIndex();
      setTimeout(refreshRiskTemperature, 500);
      updateGlobalTimestamp();
      initDragReorder();
      setInterval(() => {
        refreshSPY();
        refreshYieldCurve();
        refreshEstimatedBuffett();
        refreshTSLA();
        refreshLithium();
        refreshVIX();
        refreshVIXIndex();
        refreshRiskTemperature();
        updateGlobalTimestamp();
      }, 120000);
      setInterval(refreshRiskTemperature, 30000);
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
