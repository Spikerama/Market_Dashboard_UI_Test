<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Market Warning Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root {
      --bg:#1f212a;
      --card-bg:#2c2f40;
      --radius:18px;
      --shadow:0 25px 60px -15px rgba(0,0,0,0.6);
      --text-primary:rgba(255,255,255,0.92);
      --text-secondary:rgba(200,205,220,0.7);
      --live:#00d084;
      --cached:#6f7ea8;
      --error:#ff6f6f;
      --border:rgba(255,255,255,0.08);
      --transition:.35s cubic-bezier(.4,.2,.2,1);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:1.5rem 1rem 3rem;
      background:var(--bg);
      font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      color:var(--text-primary);
      min-height:100vh;
    }
    .app{max-width:1400px;margin:0 auto;display:flex;flex-direction:column;gap:1rem;}
    .header{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:.5rem;padding:.75rem 1rem;}
    .title{font-size:1.5rem;font-weight:700;display:flex;align-items:center;gap:.5rem;}
    .sub{font-size:.85rem;color:var(--text-secondary);margin-top:2px;}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem;margin-top:.5rem;}
    .card{position:relative;background:var(--card-bg);border-radius:var(--radius);padding:1.25rem 1rem 1.5rem;box-shadow:var(--shadow);display:flex;flex-direction:column;transition:transform var(--transition),box-shadow var(--transition);overflow:hidden;border:1px solid var(--border);}
    .card.alert{box-shadow:0 0 25px 3px var(--error);}
    .card:hover{transform:translateY(-2px);box-shadow:0 35px 80px -10px rgba(255,255,255,0.7);}
    .small-label{font-size:.55rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary);margin-bottom:4px;}
    h2{margin:0;font-size:.95rem;font-weight:600;letter-spacing:.5px;display:flex;justify-content:space-between;align-items:baseline;cursor:grab;}
    .value{font-size:2.2rem;font-weight:700;margin-top:6px;display:flex;align-items:baseline;gap:6px;color:var(--text-primary);position:relative;}
    .change{font-size:.85rem;margin-top:4px;display:flex;align-items:center;gap:4px;}
    .up{color:var(--live);}
    .down{color:var(--error);}
    .badge{
      font-size:.55rem;
      padding:6px 12px;
      border-radius:999px;
      font-weight:600;
      display:inline-block;
      margin-left:6px;
      text-transform:uppercase;
      letter-spacing:.5px;
      background: rgba(255,255,255,0.08);
      color: var(--text-primary);
    }
    .badge-live{background:var(--live);color:#000;}
    .badge-cached{background:var(--cached);color:#fff;}
    .badge-error{background:var(--error);color:#fff;}
    .timestamp{font-size:.55rem;margin-top:6px;color:var(--text-secondary);}
    .stale{font-size:.55rem;color:var(--text-secondary);margin-top:2px;}
    .spinner{width:16px;height:16px;border:3px solid rgba(255,255,255,0.1);border-top:3px solid #8b9cff;border-radius:50%;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-left:4px;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .note{font-size:.55rem;color:var(--text-secondary);margin-top:6px;}
    .mini{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-top:4px;}
    .header-right{display:flex;gap:1rem;flex-wrap:wrap;font-size:.9rem;}
    .legend{display:flex;gap:.75rem;align-items:center;}
    .legend .badge{margin:0;}
    .sparkline{width:100px;height:28px;}
    .temp-bar{width:100%;height:14px;border-radius:7px;background:linear-gradient(90deg,#28c17d 0%,#ffcd3c 60%,#ff6f6f 100%);position:relative;overflow:hidden;margin-top:4px;}
    .temp-marker{position:absolute;top:0;bottom:0;width:4px;border-radius:2px;transform:translateX(-50%);box-shadow:0 0 14px rgba(255,255,255,0.5);}
    .temp-label{margin-top:4px;font-size:.75rem;}
    .sortable-ghost{opacity:.6;transform:scale(1.02);box-shadow:0 35px 80px -10px rgba(255,255,255,0.1);}
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div>
        <div class="title">Market Warning Dashboard</div>
        <div class="sub">Dark theme · Aggregated risk temperature · Live / Cached · Smooth risk coloring</div>
      </div>
      <div class="header-right">
        <div>Global updated: <strong id="global-updated">--:--:--</strong></div>
        <div class="legend">
          <div class="badge badge-live">LIVE</div>
          <div class="badge badge-cached">CACHED</div>
          <div class="badge badge-error">ERROR</div>
        </div>
      </div>
    </div>

    <div class="grid" id="dashboard-grid">
      <!-- Risk Temperature -->
      <div class="card" data-widget="risk-temp" id="card-risk-temp">
        <div class="small-label">Aggregate</div>
        <h2>Risk Temperature</h2>
        <div class="value" style="flex-direction:column;gap:4px;">
          <div style="display:flex;align-items:center;gap:8px;">
            <div id="risk-temp-score" style="font-size:2rem;">--%</div>
            <div id="risk-temp-status" class="badge">--</div>
          </div>
          <div class="temp-bar">
            <div class="temp-marker" id="risk-temp-marker" style="left:0;background:#28c17d;"></div>
          </div>
        </div>
        <div class="temp-label" id="risk-temp-details">Loading...</div>
        <div class="timestamp" id="risk-temp-updated">Updated: --</div>
      </div>

      <!-- SPY -->
      <div class="card" data-widget="sp500" id="card-sp500">
        <div class="small-label">Equity</div>
        <h2>S&P 500 (SPY)</h2>
        <div class="value" id="sp500">
          -- <span id="sp500-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="sp500-change"></div>
          <div id="sp500-status" class="badge">--</div>
          <div class="sparkline" id="sp500-spark"></div>
        </div>
        <div class="stale" id="sp500-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="sp500-updated">Updated: --</div>
      </div>

      <!-- Yield Curve -->
      <div class="card" data-widget="yield" id="card-yield">
        <div class="small-label">Macro</div>
        <h2>10Y − 2Y Yield Curve Spread</h2>
        <div class="value" id="yield">
          -- <span id="yield-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="yield-change"></div>
          <div id="yield-status" class="badge">--</div>
          <div class="sparkline" id="yield-spark"></div>
        </div>
        <div class="stale" id="yield-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="yield-updated">Updated: --</div>
      </div>

      <!-- Other widgets remain unchanged... -->
      <!-- Buffett -->
      <div class="card" data-widget="buffett" id="card-buffett">
        <div class="small-label">Valuation</div>
        <h2>Buffett Indicator</h2>
        <div class="value" id="buffett-wrapper" style="position:relative;">
          <div class="threshold-bar" aria-hidden="true"></div>
          <div class="threshold-inner" id="buffett-threshold" style="width:0;background:#28c17d;"></div>
          <div style="position:relative;display:flex;align-items:center;gap:6px;width:100%;">
            <div id="buffett">-- <span id="buffett-spinner" class="spinner" style="display:none;"></span></div>
            <div class="threshold-label" id="buffett-label">--</div>
          </div>
        </div>
        <div class="mini">
          <div class="change" id="buffett-change"></div>
          <div id="buffett-status" class="badge">--</div>
          <div class="sparkline" id="buffett-spark"></div>
        </div>
        <div class="stale" id="buffett-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="buffett-updated">Updated: --</div>
        <div class="note">Market cap / GDP. High readings signal overvaluation.</div>
      </div>

      <!-- Estimated Buffett -->
      <div class="card" data-widget="estimated-buffett" id="card-estimated-buffett">
        <div class="small-label">Valuation</div>
        <h2>Estimated Buffett (S&P scaled)</h2>
        <div style="font-size:.6rem;margin-top:2px;">Approx: S&P 500 cap × 1.30 / GDP</div>
        <div class="value" id="estimated-buffett-wrapper" style="position:relative;">
          <div class="threshold-bar" aria-hidden="true"></div>
          <div class="threshold-inner" id="estimated-buffett-threshold" style="width:0;background:#28c17d;"></div>
          <div style="position:relative;display:flex;align-items:center;gap:6px;width:100%;">
            <div id="estimated-buffett">-- <span id="estimated-buffett-spinner" class="spinner" style="display:none;"></span></div>
            <div class="threshold-label" id="estimated-buffett-label">--</div>
          </div>
        </div>
        <div class="mini">
          <div class="change" id="estimated-buffett-change"></div>
          <div id="estimated-buffett-status" class="badge">--</div>
          <div class="sparkline" id="estimated-buffett-spark"></div>
        </div>
        <div class="stale" id="estimated-buffett-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="estimated-buffett-updated">Updated: --</div>
      </div>

      <!-- Tesla -->
      <div class="card" data-widget="tsla" id="card-tsla">
        <div class="small-label">Equity</div>
        <h2>Tesla (TSLA)</h2>
        <div class="value" id="tsla">
          -- <span id="tsla-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="tsla-change"></div>
          <div id="tsla-status" class="badge">--</div>
          <div class="sparkline" id="tsla-spark"></div>
        </div>
        <div class="stale" id="tsla-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="tsla-updated">Updated: --</div>
      </div>

      <!-- Lithium -->
      <div class="card" data-widget="lithium" id="card-lithium">
        <div class="small-label">Commodity Proxy</div>
        <h2>Lithium Spot Proxy (LIT ETF)</h2>
        <div class="value" id="lithium">
          -- <span id="lithium-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="lithium-change"></div>
          <div id="lithium-status" class="badge">--</div>
        </div>
        <div class="stale" id="lithium-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="lithium-updated">Updated: --</div>
      </div>

      <!-- VIXY -->
      <div class="card" data-widget="vixy" id="card-vixy">
        <div class="small-label">Volatility</div>
        <h2>VIXY</h2>
        <div class="value" id="vix">
          -- <span id="vix-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="vix-change"></div>
          <div id="vix-status" class="badge">--</div>
        </div>
        <div class="stale" id="vix-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="vix-updated">Updated: --</div>
      </div>

      <!-- VIX index -->
      <div class="card" data-widget="vixindex" id="card-vix-index">
        <div class="small-label">Volatility</div>
        <h2>VIX Index (^VIX)</h2>
        <div class="value" id="vix-index">
          -- <span id="vix-index-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="vix-index-change"></div>
          <div id="vix-index-status" class="badge">--</div>
        </div>
        <div class="stale" id="vix-index-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="vix-index-updated">Updated: --</div>
      </div>
    </div>

    <div class="note">
      Data sources: TwelveData for ETFs, Netlify functions for VIX index, yield spread, Estimated Buffett. Aggregated “Risk Temperature” mixes structural and near-term market stress.  
      Rule: working widgets are isolated; new features only after verified.
    </div>
  </div>

  <script>
    const TWELVE_KEY = '26137bba624c4dcb9b5284ad1b234071';

    function cacheSet(key, obj) { try { localStorage.setItem(key, JSON.stringify({ ts: Date.now(), data: obj })); } catch {} }
    function cacheGet(key) { try { return JSON.parse(localStorage.getItem(key)); } catch { return null; } }

    async function fetchWithRetry(url, attempts = 3, baseDelay = 300) {
      for (let i = 0; i < attempts; i++) {
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return await res.json();
        } catch (e) {
          if (i === attempts - 1) throw e;
          await new Promise(r => setTimeout(r, baseDelay * (i + 1)));
        }
      }
    }

    async function getTwelveQuote(symbol) {
      const url = `https://api.twelvedata.com/quote?symbol=${encodeURIComponent(symbol)}&apikey=${TWELVE_KEY}`;
      const json = await fetchWithRetry(url);
      if (!json || json.status === 'error' || typeof json.close === 'undefined') throw new Error(`Bad data for ${symbol}`);
      return json;
    }

    function setCard(id, value, change, useCache = false) {
      const valEl = document.getElementById(id);
      const changeEl = document.getElementById(id + '-change');
      const staleEl = document.getElementById(id + '-stale');
      const statusEl = document.getElementById(id + '-status');
      if (value === null || value === undefined || isNaN(value)) {
        if (valEl) valEl.textContent = 'Error';
        if (changeEl) changeEl.textContent = '';
        if (staleEl) staleEl.style.display = 'none';
        if (statusEl) { statusEl.textContent = 'ERROR'; statusEl.className='badge badge-error'; }
        return;
      }
      if (valEl) valEl.textContent = parseFloat(value).toFixed(2);
      if (typeof change === 'number' && changeEl) {
        const arrow = change >= 0 ? '▲' : '▼';
        changeEl.textContent = `${arrow} ${Math.abs(change).toFixed(2)}%`;
        changeEl.className = 'change ' + (change >= 0 ? 'up' : 'down');
      }
      if (staleEl) staleEl.style.display = useCache ? 'block' : 'none';
    }

    function pushHistory(key, value) {
      try {
        const raw = localStorage.getItem(`spark_${key}`);
        let arr = raw ? JSON.parse(raw) : [];
        arr.push(value);
        if (arr.length > 30) arr = arr.slice(-30);
        localStorage.setItem(`spark_${key}`, JSON.stringify(arr));
      } catch {}
    }
    function getHistory(key) { try { const raw = localStorage.getItem(`spark_${key}`); return raw ? JSON.parse(raw) : []; } catch { return []; } }
    function drawSparkline(containerId, data) {
      const w = 100, h = 28;
      if (!data || data.length === 0) { document.getElementById(containerId).innerHTML = ''; return; }
      const max = Math.max(...data); const min = Math.min(...data); const range = max - min || 1;
      let path = '';
      data.forEach((v,i) => {
        const x = (i/(data.length-1)) * w;
        const y = h - ((v - min) / range) * h;
        path += i === 0 ? `M${x},${y}` : ` L${x},${y}`;
      });
      const svg = `
        <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" aria-label="sparkline">
          <path d="${path}" fill="none" stroke="rgba(255,255,255,0.7)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`;
      document.getElementById(containerId).innerHTML = svg;
    }

    function interpolateColor(from, to, t) {
      const f = hex => parseInt(hex.replace('#',''),16);
      const r = (c => (c>>16)&255)(f(from));
      const g = (c => (c>>8)&255)(f(from));
      const b = (c => c&255)(f(from));
      const r2 = (c => (c>>16)&255)(f(to));
      const g2 = (c => (c>>8)&255)(f(to));
      const b2 = (c => c&255)(f(to));
      const rn = Math.round(r + (r2 - r)*t);
      const gn = Math.round(g + (g2 - g)*t);
      const bn = Math.round(b + (b2 - b)*t);
      return `rgb(${rn},${gn},${bn})`;
    }

    function riskColor(score) {
      if (score <= 50) {
        return interpolateColor('#28c17d','#ffcd3c', score/50);
      } else {
        return interpolateColor('#ffcd3c','#ff6f6f', (score-50)/50);
      }
    }

    async function refreshSPY() {
      const spinner = document.getElementById('sp500-spinner'); if (spinner) spinner.style.display='inline-block';
      try {
        const q = await getTwelveQuote('SPY');
        const price = parseFloat(q.close);
        const pct = parseFloat(q.percent_change);
        setCard('sp500', price, pct, false);
        cacheSet('sp500', { price, pct });
        document.getElementById('sp500-updated').textContent = 'Updated: '+ new Date().toLocaleTimeString();
        const statusEl = document.getElementById('sp500-status');
        if (statusEl){ statusEl.textContent='LIVE'; statusEl.className='badge badge-live'; }
        pushHistory('sp500', price);
        drawSparkline('sp500-spark', getHistory('sp500'));
      } catch (e) {
        console.error('SPY error', e);
        const cached = cacheGet('sp500');
        if (cached?.data) {
          setCard('sp500', cached.data.price, cached.data.pct, true);
          const ts = cached.ts? new Date(cached.ts).toLocaleTimeString():'--';
          document.getElementById('sp500-updated').textContent = 'Updated: '+ts+' (cached)';
          const statusEl = document.getElementById('sp500-status');
          if (statusEl){ statusEl.textContent='CACHED'; statusEl.className='badge badge-cached'; }
          pushHistory('sp500', cached.data.price);
          drawSparkline('sp500-spark', getHistory('sp500'));
        } else {
          setCard('sp500', null, null, false);
          document.getElementById('sp500-updated').textContent='Updated: --';
          const statusEl = document.getElementById('sp500-status');
          if(statusEl){ statusEl.textContent='ERROR'; statusEl.className='badge badge-error'; }
        }
      } finally { if (spinner) spinner.style.display='none'; }
    }

    async function refreshYieldCurve() {
      const spinner = document.getElementById('yield-spinner'); if (spinner) spinner.style.display='inline-block';
      try {
        const res = await fetch('/.netlify/functions/yieldSpread');
        const json = await res.json();
        if (json.error) throw new Error(json.error);
        const spread = json.spread;
        const inverted = json.inverted;
        if (document.getElementById('yield')) document.getElementById('yield').textContent = `${spread.toFixed(2)}%`;
        const changeEl = document.getElementById('yield-change');
        if (changeEl) {
          const arrow = spread >= 0 ? '▲' : '▼';
          changeEl.textContent = `${arrow} ${inverted ? 'Inverted' : 'Normal'}`;
          changeEl.className = 'change ' + (spread >= 0 ? 'up' : 'down');
        }
        cacheSet('yield', { spread, inverted });
        document.getElementById('yield-stale').style.display='none';
        document.getElementById('yield-updated').textContent='Updated: '+new Date().toLocaleTimeString();
        const statusEl = document.getElementById('yield-status');
        if (statusEl){ statusEl.textContent = inverted ? 'INVERTED' : 'NORMAL'; }
        pushHistory('yield', spread);
        drawSparkline('yield-spark', getHistory('yield'));
      } catch (e) {
        console.error('Yield curve fetch failed:', e);
        const cached = cacheGet('yield');
        if (cached?.data) {
          const spread = cached.data.spread;
          const inverted = cached.data.inverted;
          if (document.getElementById('yield')) document.getElementById('yield').textContent = `${spread.toFixed(2)}%`;
          const changeEl = document.getElementById('yield-change');
          if (changeEl) {
            const arrow = spread >= 0 ? '▲' : '▼';
            changeEl.textContent = `${arrow} ${inverted ? 'Inverted' : 'Normal'}`;
            changeEl.className = 'change ' + (spread >= 0 ? 'up' : 'down');
          }
          document.getElementById('yield-stale').style.display='block';
          const ts = cached.ts? new Date(cached.ts).toLocaleTimeString():'--';
          document.getElementById('yield-updated').textContent='Updated: '+ts+' (cached)';
          const statusEl = document.getElementById('yield-status');
          if (statusEl){ statusEl.textContent = inverted ? 'INVERTED' : 'NORMAL'; }
          pushHistory('yield', spread);
          drawSparkline('yield-spark', getHistory('yield'));
        } else {
          document.getElementById('yield-updated').textContent='Updated: --';
          const statusEl = document.getElementById('yield-status');
          if (statusEl){ statusEl.textContent='ERROR'; statusEl.className='badge badge-error'; }
        }
      }
    }

    async function refreshEstimatedBuffett() {
      const spinner = document.getElementById('estimated-buffett-spinner'); if (spinner) spinner.style.display='inline-block';
      try {
        const res = await fetch('/.netlify/functions/estimatedBuffett');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        if (json.error) throw new Error(json.error);
        const ratio = json.ratio;
        const overvalued = ratio >= 3.0;
        if (document.getElementById('estimated-buffett')) document.getElementById('estimated-buffett').textContent = `${ratio.toFixed(2)}%`;
        const changeEl = document.getElementById('estimated-buffett-change');
        if (changeEl) {
          changeEl.textContent = overvalued ? '▲ Overvalued' : (ratio >= 2.5 ? '▲ Caution' : '▼ Normal');
          changeEl.className = 'change ' + (overvalued ? 'up' : (ratio >= 2.5 ? 'up' : 'down'));
        }
        const inner = document.getElementById('estimated-buffett-threshold');
        const label = document.getElementById('estimated-buffett-label');
        const width = Math.min((ratio / 5) * 100, 100);
        inner.style.width = `${width}%`;
        if (ratio < 2.5) { inner.style.background = '#28c17d'; label.textContent='Normal'; }
        else if (ratio < 3.0) { inner.style.background='#ffcd3c'; label.textContent='Caution'; }
        else { inner.style.background='#ff6f6f'; label.textContent='Overvalued'; }
        document.getElementById('estimated-buffett-stale').style.display='none';
        document.getElementById('estimated-buffett-updated').textContent='Updated: '+new Date().toLocaleTimeString();
        const statusEl = document.getElementById('estimated-buffett-status');
        if (statusEl){ statusEl.textContent = overvalued ? 'ALERT' : 'OK'; statusEl.className = overvalued ? 'badge badge-error' : 'badge'; }
        cacheSet('estimated-buffett', { ratio, overvalued }); pushHistory('estimated-buffett', ratio); drawSparkline('estimated-buffett-spark', getHistory('estimated-buffett'));
      } catch (e) {
        console.error('Estimated Buffett error', e);
        const cached = cacheGet('estimated-buffett');
        if (cached?.data) {
          const ratio = cached.data.ratio;
          const overvalued = ratio >= 3.0;
          if (document.getElementById('estimated-buffett')) document.getElementById('estimated-buffett').textContent = `${ratio.toFixed(2)}%`;
          const changeEl = document.getElementById('estimated-buffett-change');
          if (changeEl) {
            changeEl.textContent = overvalued ? '▲ Overvalued' : (ratio >= 2.5 ? '▲ Caution' : '▼ Normal');
            changeEl.className = 'change ' + (overvalued ? 'up' : (ratio >= 2.5 ? 'up' : 'down'));
          }
          const inner = document.getElementById('estimated-buffett-threshold');
          const label = document.getElementById('estimated-buffett-label');
          const width = Math.min((ratio / 5) * 100, 100);
          inner.style.width = `${width}%`;
          if (ratio < 2.5) { inner.style.background = '#28c17d'; label.textContent='Normal'; }
          else if (ratio < 3.0) { inner.style.background='#ffcd3c'; label.textContent='Caution'; }
          else { inner.style.background='#ff6f6f'; label.textContent='Overvalued'; }
          document.getElementById('estimated-buffett-stale').style.display='block';
          document.getElementById('estimated-buffett-updated').textContent='Updated: '+new Date(cached.ts).toLocaleTimeString()+' (cached)';
          const statusEl = document.getElementById('estimated-buffett-status');
          if (statusEl){ statusEl.textContent = overvalued ? 'ALERT' : 'OK'; statusEl.className = overvalued ? 'badge badge-error' : 'badge'; }
          pushHistory('estimated-buffett', ratio); drawSparkline('estimated-buffett-spark', getHistory('estimated-buffett'));
        } else {
          if (document.getElementById('estimated-buffett')) document.getElementById('estimated-buffett').textContent='Error';
          const changeEl = document.getElementById('estimated-buffett-change'); if (changeEl) changeEl.textContent='';
          const statusEl = document.getElementById('estimated-buffett-status'); if (statusEl){ statusEl.textContent='ERROR'; statusEl.className='badge badge-error'; }
        }
      }
    }

    async function refreshTSLA() {
      const spinner = document.getElementById('tsla-spinner'); if (spinner) spinner.style.display='inline-block';
      try {
        const q = await getTwelveQuote('TSLA');
        const price = parseFloat(q.close);
        const pct = parseFloat(q.percent_change);
        setCard('tsla', price, pct, false);
        cacheSet('tsla',{ price,pct });
        document.getElementById('tsla-updated').textContent='Updated: '+new Date().toLocaleTimeString();
        const statusEl=document.getElementById('tsla-status');
        if(statusEl){ statusEl.textContent='LIVE'; statusEl.className='badge badge-live'; }
        pushHistory('tsla', price);
        drawSparkline('tsla-spark', getHistory('tsla'));
      } catch(e){
        console.error('TSLA error', e);
        const cached=cacheGet('tsla');
        if(cached?.data){
          setCard('tsla', cached.data.price, cached.data.pct,true);
          const ts=cached.ts?new Date(cached.ts).toLocaleTimeString():'--';
          document.getElementById('tsla-updated').textContent='Updated: '+ts+' (cached)';
          const statusEl=document.getElementById('tsla-status');
          if(statusEl){ statusEl.textContent='CACHED'; statusEl.className='badge badge-cached'; }
          pushHistory('tsla', cached.data.price);
          drawSparkline('tsla-spark', getHistory('tsla'));
        } else {
          setCard('tsla', null,null,false);
          document.getElementById('tsla-updated').textContent='Updated: --';
          const statusEl=document.getElementById('tsla-status');
          if(statusEl){ statusEl.textContent='ERROR'; statusEl.className='badge badge-error'; }
        }
      }
    }

    async function refreshLithium() {
      const spinner=document.getElementById('lithium-spinner'); if(spinner) spinner.style.display='inline-block';
      try{
        const q=await getTwelveQuote('LIT');
        const price=parseFloat(q.close);
        const pct=parseFloat(q.percent_change);
        setCard('lithium', price, pct,false);
        cacheSet('lithium',{ price,pct });
        document.getElementById('lithium-updated').textContent='Updated: '+new Date().toLocaleTimeString();
        const statusEl=document.getElementById('lithium-status');
        if(statusEl){ statusEl.textContent='LIVE'; statusEl.className='badge badge-live'; }
      } catch(e){
        console.error('Lithium error', e);
        const cached=cacheGet('lithium');
        if(cached?.data){
          setCard('lithium', cached.data.price, cached.data.pct,true);
          const ts=cached.ts?new Date(cached.ts).toLocaleTimeString():'--';
          document.getElementById('lithium-updated').textContent='Updated: '+ts+' (cached)';
          const statusEl=document.getElementById('lithium-status');
          if(statusEl){ statusEl.textContent='CACHED'; statusEl.className='badge badge-cached'; }
        } else {
          setCard('lithium',null,null,false);
          document.getElementById('lithium-updated').textContent='Updated: --';
          const statusEl=document.getElementById('lithium-status');
          if(statusEl){ statusEl.textContent='ERROR'; statusEl.className='badge badge-error'; }
        }
      }
    }

    async function refreshVIX() {
      const spinner=document.getElementById('vix-spinner'); if(spinner) spinner.style.display='inline-block';
      try{
        const q=await getTwelveQuote('VIXY');
        const price=parseFloat(q.close);
        const pct=parseFloat(q.percent_change);
        setCard('vix', price, pct,false);
        cacheSet('vix',{ price,pct });
        document.getElementById('vix-updated').textContent='Updated: '+new Date().toLocaleTimeString();
        const statusEl=document.getElementById('vix-status');
        if(statusEl){ statusEl.textContent='LIVE'; statusEl.className='badge badge-live'; }
      } catch(e){
        console.error('VIXY error', e);
        const cached=cacheGet('vix');
        if(cached?.data){
          setCard('vix', cached.data.price, cached.data.pct,true);
          const ts=cached.ts?new Date(ccached.ts).toLocaleTimeString():'--';
          document.getElementById('vix-updated').textContent='Updated: '+ts+' (cached)';
          const statusEl=document.getElementById('vix-status');
          if(statusEl){ statusEl.textContent='CACHED'; statusEl.className='badge badge-cached'; }
        } else {
          setCard('vix',null,null,false);
          document.getElementById('vix-updated').textContent='Updated: --';
          const statusEl=document.getElementById('vix-status');
          if(statusEl){ statusEl.textContent='ERROR'; statusEl.className='badge badge-error'; }
        }
      }
    }

    async function refreshVIXIndex() {
      const spinner=document.getElementById('vix-index-spinner'); if(spinner) spinner.style.display='inline-block';
      try{
        const res=await fetch('/.netlify/functions/vixIndex');
        const json=await res.json();
        if(json.error) throw new Error(json.error);
        const price=parseFloat(json.price);
        const change=json.changePercent!=null?parseFloat(json.changePercent):null;
        setCard('vix-index', price, change,false);
        cacheSet('vix-index',{ price, change });
        document.getElementById('vix-index-updated').textContent='Updated: '+new Date().toLocaleTimeString();
        const statusEl=document.getElementById('vix-index-status');
        if(statusEl){ statusEl.textContent='LIVE'; statusEl.className='badge badge-live'; }
      } catch(e){
        console.error('VIX index error', e);
        const cached=cacheGet('vix-index');
        if(cached?.data){
          setCard('vix-index', cached.data.price, cached.data.change,true);
          const ts=cached.ts?new Date(ccached.ts).toLocaleTimeString():'--';
          document.getElementById('vix-index-updated').textContent='Updated: '+ts+' (cached)';
          const statusEl=document.getElementById('vix-index-status');
          if(statusEl){ statusEl.textContent='CACHED'; statusEl.className='badge badge-cached'; }
        } else {
          if(document.getElementById('vix-index')) document.getElementById('vix-index').textContent='No data';
          document.getElementById('vix-index-change').textContent='';
          document.getElementById('vix-index-updated').textContent='Updated: --';
          const statusEl=document.getElementById('vix-index-status');
          if(statusEl){ statusEl.textContent='NO DATA'; statusEl.className='badge'; }
        }
      }
    }

    function refreshRiskTemperature() {
      const now = new Date();
      const est = cacheGet('estimated-buffett')?.data;
      const yieldc = cacheGet('yield')?.data;
      const spy = cacheGet('sp500')?.data;
      const vixy = cacheGet('vix')?.data;
      const tsla = cacheGet('tsla')?.data;

      let score = 0;
      const contributors = [];

      if (yieldc && yieldc.spread < 0) { score += 25; contributors.push('Yield inverted'); }
      if (est && est.ratio >= 3.0) { score += 30; contributors.push(`Est. Buffett ≥ ${est.ratio.toFixed(2)}`); }
      if (spy && typeof spy.pct === 'number' && spy.pct <= -1) { score += 10; contributors.push(`SPY down ${spy.pct.toFixed(2)}%`); }
      if (vixy && typeof vixy.pct === 'number' && vixy.pct >= 5) { score += 10; contributors.push(`VIXY up ${vixy.pct.toFixed(2)}%`); }
      if (tsla && typeof tsla.pct === 'number' && tsla.pct <= -1.5) { score += 10; contributors.push(`TSLA down ${tsla.pct.toFixed(2)}%`); }

      score = Math.min(100, score);

      const marker = document.getElementById('risk-temp-marker');
      const statusEl = document.getElementById('risk-temp-status');
      const scoreEl = document.getElementById('risk-temp-score');
      const detailsEl = document.getElementById('risk-temp-details');
      const updatedEl = document.getElementById('risk-temp-updated');

      const color = riskColor(score);
      if (marker) {
        marker.style.left = `${score}%`;
        marker.style.background = color;
      }
      if (scoreEl) scoreEl.textContent = `${score}%`;

      let statusText = 'Normal';
      if (score >= 70) statusText = 'High Risk';
      else if (score >= 40) statusText = 'Elevated';

      if (statusEl) {
        statusEl.textContent = statusText;
        statusEl.style.color = color;
        statusEl.style.background = 'rgba(255,255,255,0.08)';
      }
      if (detailsEl) { detailsEl.textContent = contributors.length ? contributors.join(', ') : 'No major stress signals'; }
      if (updatedEl) updatedEl.textContent = 'Updated: ' + now.toLocaleTimeString();

      const card = document.getElementById('card-risk-temp');
      if (card) {
        if (score >= 70) card.classList.add('alert'); else card.classList.remove('alert');
      }
    }

    function initDragReorder() {
      const grid = document.getElementById('dashboard-grid');
      if (!grid) return;
      const saved = localStorage.getItem('dashboard_order');
      if (saved) {
        try {
          const order = JSON.parse(saved);
          order.forEach(widgetId => {
            const card = document.querySelector(`[data-widget="${widgetId}"]`);
            if (card && grid.contains(card)) grid.appendChild(card);
          });
        } catch {}
      }
      Sortable.create(grid, { animation:150, handle:'h2', ghostClass:'sortable-ghost', onEnd: () => {
        const kids = Array.from(grid.children);
        const order = kids.map(c => c.getAttribute('data-widget')).filter(Boolean);
        localStorage.setItem('dashboard_order', JSON.stringify(order));
      }});
    }

    function updateGlobalTimestamp() { document.getElementById('global-updated').textContent = new Date().toLocaleTimeString(); }

    async function boot() {
      refreshSPY();
      refreshYieldCurve();
      refreshEstimatedBuffett();
      refreshTSLA();
      refreshLithium();
      refreshVIX();
      refreshVIXIndex();
      setTimeout(refreshRiskTemperature, 500);
      updateGlobalTimestamp();
      initDragReorder();
      setInterval(() => {
        refreshSPY();
        refreshYieldCurve();
        refreshEstimatedBuffett();
        refreshTSLA();
        refreshLithium();
        refreshVIX();
        refreshVIXIndex();
        refreshRiskTemperature();
        updateGlobalTimestamp();
      }, 120000);
      setInterval(refreshRiskTemperature, 30000);
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
